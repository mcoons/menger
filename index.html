<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
    <title>Babylon - Getting Started</title>
    <!--- Link to the last version of BabylonJS --->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <style>
        html, body {
            overflow: hidden;
            width   : 100%;
            height  : 100%;
            margin  : 0;
            padding : 0;
        }

        #renderCanvas {
            width   : 100%;
            height  : 100%;
            touch-action: none;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        var maxInterval = 4;  // not to exceed 6
        const initialScale = 243*3;
        const remove = [22, 16, 14, 13, 12, 10, 4];
        const scales = [243, 81, 27, 9, 3 ,1, 1/3];
        const cloneScales = [1, 1/3, 1/9, 1/27, 1/81, 1/243];
        var objectCount = 0;
        var initialMeshes = [];
        var clone;
        var template;
        var final;
        var camera;
        var direction = 1;

        window.addEventListener('DOMContentLoaded', function(){
            // get the canvas DOM element
            var canvas = document.getElementById('renderCanvas');

            // load the 3D engine
            var engine = new BABYLON.Engine(canvas, true);

            // createScene function that creates and return the scene
            var createScene = function(){
                // create a basic BJS Scene object
                var scene = new BABYLON.Scene(engine);

                // create a FreeCamera, and set its position to (x:0, y:5, z:-10)
                camera = new BABYLON.FreeCamera('camera1', new BABYLON.Vector3(0, 45, -150), scene);

                // target the camera to scene origin
                camera.setTarget(new BABYLON.Vector3(0,45,-200));

                // attach the camera to the canvas
                camera.attachControl(canvas, false);

                // create a basic light, aiming 0,1,0 - meaning, to the sky
                var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0,1,0), scene);
                light.intensity = .7;
                var dLight = new BABYLON.DirectionalLight("DirectionalLight", new BABYLON.Vector3(-5, -5, -1.5), scene);
 
                var greenMat = new BABYLON.StandardMaterial("green", scene);
                greenMat.diffuseColor = BABYLON.Color3.Green();
                // greenMat.bumpTexture = new BABYLON.Texture("normal.png", scene);

                calculateCenters(new BABYLON.Vector3(0,0,0), 1, scene, greenMat, true);

                template = BABYLON.Mesh.MergeMeshes(initialMeshes, true, true);
                template.position = new BABYLON.Vector3(0,0,-1050);
                initialMeshes.forEach(m => m.dispose());
                // initialMeshes = [];

                maxInterval = 3;
                calculateCenters(new BABYLON.Vector3(0,0,0), 1, scene, greenMat, false);

                // final = BABYLON.Mesh.MergeMeshes(initialMeshes, true, true);
                // final.position = new BABYLON.Vector3(0,0,0);
                // initialMeshes.forEach(m => m.dispose());
                // initialMeshes = [];

                // return the created scene
                return scene;
            }

            // call the createScene function
            var scene = createScene();

            // run the render loop
            engine.runRenderLoop(function(){
                camera.position.z +=.2*direction; 
                if (camera.position.z > 500) direction*=-1;
                if (camera.position.z < -150)  direction*=-1;
                console.log(camera.position);
                scene.render();
            });

            // the canvas/window resize event handler
            window.addEventListener('resize', function(){
                engine.resize();
            });
        });

        function calculateCenters(center, i, scene, mat, initial){
            let myScale = scales[i-1];
            let box;

            if (i === maxInterval){
                if (initial){
                    box = BABYLON.MeshBuilder.CreateBox("box", {height: myScale, width: myScale, depth: myScale}, scene);
                }
                else {
                    box = template.clone("clone");                    
                    box.scaling.x = cloneScales[i-1];
                    box.scaling.y = cloneScales[i-1];
                    box.scaling.z = cloneScales[i-1];
                }
                box.position = center;
                box.material = mat;
                initialMeshes.push(box);
                return;
            }

            let s3 = scales[i];
            let count = 0;

            for (let y = center.y-s3; y <= center.y+s3; y+=s3)
            for (let z = center.z-s3; z <= center.z+s3; z+=s3)
            for (let x = center.x-s3; x <= center.x+s3; x+=s3){
                if (!remove.includes(count))
                    calculateCenters(new BABYLON.Vector3(x,y,z), i+1, scene, mat, initial);
                count++;
            }
        }

    </script>
</body>
</html>